name: Test Fireworks AI API

on:
  workflow_dispatch:
    inputs:
      prompt:
        description: 'Prompt de teste'
        required: true
        default: 'Explique o que Ã© streaming em 10 palavras'

jobs:
  test-api:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Test API Call with Streaming
        env:
          FIREWORKS_API_KEY: ${{ secrets.FIREWORKS_API_KEY }}
          PROMPT: ${{ github.event.inputs.prompt }}
        run: |
          echo "ğŸš€ Chamando Fireworks AI com streaming..."
          
          # Faz chamada COM STREAMING
          RESPONSE=$(curl -s -N https://api.fireworks.ai/inference/v1/chat/completions \
            -H "Authorization: Bearer $FIREWORKS_API_KEY" \
            -H "Content-Type: application/json" \
            -d "{
              \"model\": \"accounts/fireworks/models/kimi-k2-thinking\",
              \"max_tokens\": 16000,
              \"top_p\": 1,
              \"top_k\": 40,
              \"presence_penalty\": 0,
              \"frequency_penalty\": 0,
              \"temperature\": 1,
              \"messages\": [
                {
                  \"role\": \"user\",
                  \"content\": \"$PROMPT\"
                }
              ],
              \"stream\": true
            }" | while read -r line; do
              # Processa cada linha do stream
              if [[ $line == data:* ]]; then
                JSON_DATA=${line:6}
                if [[ "$JSON_DATA" != "[DONE]" ]]; then
                  # Extrai reasoning_content (Kimi K2 specific)
                  CONTENT=$(echo "$JSON_DATA" | jq -r '.choices[0].delta.reasoning_content // empty' 2>/dev/null)
                  if [[ ! -z "$CONTENT" ]]; then
                    echo -n "$CONTENT"
                  fi
                fi
              fi
            done)
          
          echo ""
          echo "âœ… RESULTADO FINAL:"
          echo "$RESPONSE"
          
          # Salva para debug
          echo "$RESPONSE" > test-result.txt
          
          # Mostra tamanho
          echo ""
          echo "ğŸ“ Tamanho da resposta: ${#RESPONSE} caracteres"
