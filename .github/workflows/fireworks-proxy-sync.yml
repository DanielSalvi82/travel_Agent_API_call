name: Fireworks AI Proxy

on:
  repository_dispatch:
    types: [fireworks-request-sync]
  workflow_dispatch:
    inputs:
      prompt:
        description: 'Prompt para o Kimi K2'
        required: true
        type: string
      request_id:
        description: 'ID único da requisição'
        required: true
        type: string
      webhook_url:
        description: 'URL do webhook Make.com'
        required: true
        type: string

jobs:
  process-api:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Sanitize request_id
        id: sanitize
        env:
          RAW_REQUEST_ID: ${{ github.event.inputs.request_id || github.event.client_payload.request_id }}
        run: |
          # Remove caracteres inválidos: :, <, >, |, *, ?, \, /, ", \r, \n
          SANITIZED_ID=$(echo "$RAW_REQUEST_ID" | sed 's/[:<>|*?\\\/\"\\r\\n]/-/g')
          echo "sanitized_id=$SANITIZED_ID" >> $GITHUB_OUTPUT
          echo "Original ID: $RAW_REQUEST_ID"
          echo "Sanitized ID: $SANITIZED_ID"

      - name: Process Fireworks AI Streaming
        env:
          FIREWORKS_API_KEY: ${{ secrets.FIREWORKS_API_KEY }}
          PROMPT: ${{ github.event.inputs.prompt || github.event.client_payload.prompt }}
          REQUEST_ID: ${{ steps.sanitize.outputs.sanitized_id }}
          WEBHOOK_URL: ${{ github.event.inputs.webhook_url || github.event.client_payload.webhook_url }}
        run: |
          # Faz chamada com streaming
          RESPONSE=$(curl -s -N https://api.fireworks.ai/inference/v1/chat/completions \
            -H "Authorization: Bearer $FIREWORKS_API_KEY" \
            -H "Content-Type: application/json" \
            -d "{
              \"model\": \"accounts/fireworks/models/kimi-k2-thinking\",
              \"max_tokens\": 16000,
              \"temperature\": 0.7,
              \"messages\": [{\"role\": \"user\", \"content\": \"$PROMPT\"}],
              \"stream\": true
            }" | while read -r line; do
              if [[ $line == data:* ]]; then
                JSON_DATA=${line:6}
                if [[ "$JSON_DATA" != "[DONE]" ]]; then
                  CONTENT=$(echo "$JSON_DATA" | jq -r '.choices[0].delta.reasoning_content // empty' 2>/dev/null)
                  if [[ ! -z "$CONTENT" ]]; then
                    echo -n "$CONTENT"
                  fi
                fi
              fi
            done)
          
          echo "Resultado obtido: ${#RESPONSE} caracteres"
          
          # Salva como artifact (opcional)
          echo "$RESPONSE" > "response-${REQUEST_ID}.txt"
          
          # Envia para webhook do Make.com
          curl -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{
              \"request_id\": \"$REQUEST_ID\",
              \"status\": \"completed\",
              \"result\": $(echo "$RESPONSE" | jq -R -s '.')
            }"

      - name: Upload artifact (opcional)
        uses: actions/upload-artifact@v4
        with:
          name: response-${{ steps.sanitize.outputs.sanitized_id }}
          path: response-*.txt
          retention-days: 1
