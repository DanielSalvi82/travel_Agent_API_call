name: Fireworks AI Push Callback (complete, timeout 5m)

on:
  repository_dispatch:
    types: [fireworks-request-sync]
  workflow_dispatch:
    inputs:
      prompt:
        required: true
        type: string
      request_id:
        required: true
        type: string
      webhook_url:
        required: true
        type: string
      shared_secret:
        required: true
        type: string

jobs:
  process-api:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install jq and openssl (if missing)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq openssl xxd

      - name: Process Fireworks AI Streaming and send callback
        env:
          FIREWORKS_API_KEY: ${{ secrets.FIREWORKS_API_KEY }}
          SHARED_SECRET: ${{ secrets.SHARED_SECRET || github.event.inputs.shared_secret || github.event.client_payload.shared_secret }}
          PROMPT: ${{ github.event.inputs.prompt || github.event.client_payload.prompt }}
          REQUEST_ID: ${{ github.event.inputs.request_id || github.event.client_payload.request_id }}
          WEBHOOK_URL: ${{ github.event.inputs.webhook_url || github.event.client_payload.webhook_url }}
        run: |
          set -euo pipefail

          # Safety checks
          if [ -z "${FIREWORKS_API_KEY:-}" ]; then
            echo "FIREWORKS_API_KEY is not set"; exit 1
          fi
          if [ -z "${WEBHOOK_URL:-}" ]; then
            echo "WEBHOOK_URL is not set"; exit 1
          fi
          if [ -z "${REQUEST_ID:-}" ]; then
            echo "REQUEST_ID is not set"; exit 1
          fi

          RESPONSE=""
          ANALYSIS=""
          ERROR_MSG=""

          REQUEST_BODY=$(jq -n \
            --arg prompt "$PROMPT" \
            '{
              model: "accounts/fireworks/models/kimi-k2-thinking",
              max_tokens: 16000,
              temperature: 0.5,
              messages: [{role: "user", content: $prompt}],
              stream: true
            }')

          echo "Starting streaming request to Fireworks..."
          # Stream and accumulate content lines
          while read -r line; do
            if [[ $line == data:* ]]; then
              JSON_DATA=${line:6}
              if [[ "$JSON_DATA" != "[DONE]" ]]; then
                PART_RESPONSE=$(echo "$JSON_DATA" | jq -r '.choices[0].delta.content // empty' 2>/dev/null || true)
                if [[ -n "$PART_RESPONSE" ]]; then
                  if [[ -n "$RESPONSE" ]]; then
                    RESPONSE+=$'\n'"$PART_RESPONSE"
                  else
                    RESPONSE="$PART_RESPONSE"
                  fi
                fi

                PART_ANALYSIS=$(echo "$JSON_DATA" | jq -r '.choices[0].delta.reasoning_content // empty' 2>/dev/null || true)
                if [[ -n "$PART_ANALYSIS" ]]; then
                  ANALYSIS+="$PART_ANALYSIS"
                fi

                PART_ERROR=$(echo "$JSON_DATA" | jq -r '.error.message // empty' 2>/dev/null || true)
                if [[ -n "$PART_ERROR" ]]; then
                  if [[ -n "$ERROR_MSG" ]]; then
                    ERROR_MSG+=$'\n'"$PART_ERROR"
                  else
                    ERROR_MSG="$PART_ERROR"
                  fi
                fi
              fi
            fi
          done < <(
            curl -s -N https://api.fireworks.ai/inference/v1/chat/completions \
              -H "Authorization: Bearer $FIREWORKS_API_KEY" \
              -H "Content-Type: application/json" \
              -d "$REQUEST_BODY"
          )

          RESPONSE="$(printf '%s' "$RESPONSE" | sed -e 's/^[[:space:]\n\r]*//' -e 's/[[:space:]\n\r]*$//')"
          ANALYSIS="$(printf '%s' "$ANALYSIS" | sed -e 's/^[[:space:]\n\r]*//' -e 's/[[:space:]\n\r]*$//')"
          ERROR_MSG="$(printf '%s' "$ERROR_MSG" | sed -e 's/^[[:space:]\n\r]*//' -e 's/[[:space:]\n\r]*$//')"

          echo "Streaming complete. Response length: ${#RESPONSE} chars"

          PAYLOAD=$(jq -n \
            --arg request_id "$REQUEST_ID" \
            --arg status "completed" \
            --arg response "$RESPONSE" \
            --arg analysis "$ANALYSIS" \
            --arg error "$ERROR_MSG" \
            --arg shared_secret "$SHARED_SECRET" \
            '{request_id:$request_id, status:$status, response:$response, analysis:$analysis, error:$error, shared_secret:$shared_secret, response_markdown:true}')

          SIG=""
          if [[ -n "$SHARED_SECRET" ]]; then
            SIG=$(printf '%s' "$PAYLOAD" | openssl dgst -sha256 -hmac "$SHARED_SECRET" -binary | xxd -p -c 256)
            SIG="sha256=$SIG"
          fi

          echo "Callback payload preview (truncated):"
          echo "$PAYLOAD" | jq '{request_id, status, response_length: (.response|length), error: .error}'

          # Send callback with signature header
          if [[ -n "$SIG" ]]; then
            curl -s -X POST "$WEBHOOK_URL" \
              -H "Content-Type: application/json" \
              -H "X-Signature: $SIG" \
              -d "$PAYLOAD"
          else
            curl -s -X POST "$WEBHOOK_URL" \
              -H "Content-Type: application/json" \
              -d "$PAYLOAD"
          fi

          echo "Callback sent to $WEBHOOK_URL"
